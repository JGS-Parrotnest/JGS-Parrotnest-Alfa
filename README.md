<div align="center">

# ğŸ¦œ Parrotnest   
Modern Realâ€‘Time Chat & Collaboration Platform

![.NET](https://img.shields.io/badge/.NET-8%2B-blueviolet?style=flat-square)
![ASP.NET Core](https://img.shields.io/badge/ASP.NET_Core-SignalR-5C2D91?style=flat-square)
![SQLite](https://img.shields.io/badge/DB-SQLite-blue?style=flat-square)
![Status](https://img.shields.io/badge/status-Active-brightgreen?style=flat-square)

</div>

---

## âœ¨ Overview

Parrotnest is a realâ€‘time chat application built for classrooms, small communities, and friend groups.  
It combines:

- ğŸ–¥ **Windows desktop host** (WinForms shell) that runs the server (`ParrotnestServer.exe`)
- ğŸŒ **ASP.NET Core** API with SignalR for realâ€‘time messaging
- ğŸ“„ **PHP + Vanilla JS** client served directly by the server
- ğŸ’¾ **SQLite** database for users, friendships, messages, groups and admin logs

The goal is to provide a â€œDiscordâ€‘likeâ€ experience that is:

- easy to deploy on a single Windows machine,
- selfâ€‘contained (no external DB required by default),
- friendly for school environments and LAN labs.

---

## ğŸ§± Architecture

At a high level the system looks like this:

```text
+---------------------------+       +------------------------+
|  Windows Host (WinForms)  |       |        Browser         |
|  - ServerControlForm      |       |  - index.php / login   |
|  - Start/Stop server      | <---> |  - app.js (SignalR)    |
+-------------+-------------+       +-----------+------------+
              |                                 |
              v                                 v
        +-----+---------------------------------+------+
        |         ASP.NET Core / Kestrel Server       |
        |  - Controllers (Users, Messages, Files...)  |
        |  - SignalR ChatHub                          |
        |  - Static file host for /Client             |
        +-----------------+---------------------------+
                          |
                          v
                    +-----+------+
                    |  SQLite DB |
                    | parrotnest |
                    +------------+
```

Key folders:

- `Server/` â€“ C# backend (`ParrotnestServer.csproj`, WinForms host + ASP.NET Core app)
- `Client/` â€“ PHP/HTML/JS frontend (chat UI, login, settings, etc.)
- `Server/database.sql` / `Server/BAZA_DANYCH.md` â€“ database schema and documentation

---

## ğŸš€ Features

- ğŸ’¬ **Direct & group messaging**
  - Private chats between users
  - Group conversations
  - Global â€œgeneralâ€ channel

- ğŸ–¼ **Rich messaging**
  - Text messages
  - Image attachments (PNG/JPG/GIF/WebP/BMP)
  - Large file uploads via chunked upload API
  - Replying to messages (threadâ€‘like UX)
  - Emoji reactions to messages

- ğŸ‘¤ **User system**
  - Registration & login
  - Unique usernames and emails
  - Configurable user status
  - Avatars with upload & replacement
  - Theming and text size preferences

- ğŸ¤ **Social graph**
  - Friend requests (Pending / Accepted / Blocked)
  - Friend list and mutuals
  - Group membership with role of owner

- ğŸ›¡ **Admin panel**
  - Ban / unban users
  - Mute / unmute users
  - Delete users (with cascading cleanup of messages/groups)
  - Clear global channel
  - Admin action logs (who did what, when)

- ğŸ“¡ **Realâ€‘time transport**
  - SignalR hub for realâ€‘time messaging
  - JWTâ€‘based authentication for both REST and SignalR

- ğŸ“‚ **File handling**
  - Small image uploads via `/api/messages/upload`
  - Avatar uploads via `/api/users/avatar`
  - Chunked upload API via `/api/files/*` for large files
  - Secure static delivery from the `Client/uploads` tree

---

## ğŸ›  Tech Stack

- **Backend**
  - .NET `net10.0-windows`
  - ASP.NET Core (controllers + middleware)
  - SignalR for realâ€‘time communication
  - Entity Framework Core (SQLite provider)
  - JWT authentication (`Microsoft.AspNetCore.Authentication.JwtBearer`)
  - WinForms host application (`ServerControlForm`)

- **Frontend**
  - PHP templates (`index.php`, `login.php`, â€¦) served as static files
  - Vanilla JavaScript (`Client/app.js`) â€“ all chat logic lives here
  - HTML/CSS UI, with CSS assets generated by a helper tool (`Client/CssGen`)

- **Database**
  - SQLite (`parrotnest.db`), autoâ€‘created via `EnsureCreated()`
  - Rich schema with users, friendships, groups, messages, group members, admin logs

---

## ğŸ“‚ Project Layout

```text
Parrotnest/
â”œâ”€ Client/
â”‚  â”œâ”€ index.php             # Main chat UI
â”‚  â”œâ”€ login.php             # Login screen (default open in browser)
â”‚  â”œâ”€ app.js                # Frontend logic (SignalR, uploads, UI)
â”‚  â”œâ”€ uploads/              # Uploaded files & avatars (created at runtime)
â”‚  â””â”€ CssGen/               # CSS generator utility (C#)
â”œâ”€ Server/
â”‚  â”œâ”€ Controllers/          # ASP.NET Core controllers (Users, Messages, Files, Admin, ...)
â”‚  â”œâ”€ Hubs/ChatHub.cs       # SignalR hub (realâ€‘time messaging)
â”‚  â”œâ”€ Data/ApplicationDbContext.cs # EF Core DbContext
â”‚  â”œâ”€ Models/               # EF entities (User, Message, Group, ...)
â”‚  â”œâ”€ ServerHost.cs         # Configures Kestrel, DI, routing, static files
â”‚  â”œâ”€ ServerControlForm.cs  # WinForms host (Start/Stop, Open browser)
â”‚  â”œâ”€ Program.cs            # Entry point (GUI or headless)
â”‚  â”œâ”€ ParrotnestServer.csproj
â”‚  â”œâ”€ database.sql          # SQL schema (reference)
â”‚  â”œâ”€ BAZA_DANYCH.md        # DB documentation (PL)
â”‚  â””â”€ PRODUCTION_DEPLOY.md  # Production deployment notes (PL)
â”œâ”€ README.md                # You are here ğŸ™‚
â””â”€ ParrotnestServer.exe     # exe
```

---

## ğŸ§© Core Concepts

### Users & Authentication

- Users are stored in the `Users` table with unique `Username` and `Email`.
- Passwords are stored as BCrypt hashes.
- Login returns a **JWT token** which is then:
  - sent as `Authorization: Bearer <token>` to REST APIs,
  - used by SignalR via the `access_token` query parameter.

The backend uses `JwtBearer` authentication and passes the user ID via `ClaimTypes.NameIdentifier`.  
Most controller actions and the SignalR hub are decorated with `[Authorize]`.

### Messages

- Each message may belong to:
  - a **direct chat** (SenderId + ReceiverId),
  - a **group** (GroupId),
  - or the **global channel** (no ReceiverId & no GroupId).
- Messages can contain:
  - text (`Content`),
  - an image / file URL (`ImageUrl`),
  - a reply reference (`ReplyToId`),
  - reactions (stored as JSON string).

Messages are persisted with EF Core in `ChatHub.SendMessage` and loaded via `MessagesController.GetMessages`.

### Friendships & Groups

- **Friendships** track pending and accepted friend relations between two users.
- **Groups** allow multiple users to chat in one room.
- `GroupMembers` ties users to groups with join timestamps.

### Admin Actions

- Every admin action (ban/mute/delete/clear) is logged in `AdminActionLogs`.
- Admins are identified by `User.IsAdmin == true`.

---

## âš™ï¸ Running the Application (Development)

> ğŸ“ Note: Commands assume you have the .NET SDK installed and are running them from the repository root (`Alfa v8`).

### 1. Requirements

- Windows 10/11
- .NET SDK compatible with `net10.0-windows`
- Modern browser (Chrome, Edge, Firefox)

### 2. Build the Server

```bash
cd Server
dotnet build ParrotnestServer.csproj -c Debug
```

This compiles the WinForms host (`ParrotnestServer.exe`) plus the ASP.NET Core server.

### 3. Start the Server (GUI mode)

From the `Server` directory:

```bash
dotnet run --project ParrotnestServer.csproj
```

What happens:

- A **Windows Form** (`ServerControlForm`) opens.
- Click **â€œStart Serverâ€** to launch the embedded ASP.NET Core server.
- Click **â€œOtwÃ³rz Appâ€** to open `http://localhost:6069/login.php` in your browser.

### 4. Start the Server (Headless / no GUI)

You can also run without the WinForms UI:

```bash
cd Server
dotnet run --project ParrotnestServer.csproj -- --server
```

or

```bash
Server\bin\Debug\net10.0-windows\ParrotnestServer.exe --server
```

The server listens on `http://0.0.0.0:6069` by default.  
You can override the port with:

```bash
set PARROTNEST_PORT=8080
Server\bin\Release\net10.0-windows\ParrotnestServer.exe --server
```

### 5. Open the Client

Once the server is running:

- Navigate to `http://localhost:6069/login.php` to log in.
- After login, you will be redirected to the main chat (`index.php`).

---

## ğŸ—‚ File Uploads & Storage

### Small Images (Chat Attachments)

Flow:

1. In the chat input, the user clicks the ğŸ“ attachment button.
2. `Client/app.js` reads the file from `<input type="file" id="imageInput">`.
3. If the file is small (â‰¤ 5 MB), the client:
   - Sends it as `multipart/form-data` to `POST /api/messages/upload`.
   - Receives a JSON response `{ "url": "/uploads/<guid>.<ext>" }`.
4. This `url` is attached to the message as `ImageUrl`.

Backend implementation:

- `Server/Controllers/MessagesController.cs` (`UploadImage` action)
  - Validates extension (`.png`, `.jpg`, `.jpeg`, `.gif`, `.webp`, `.bmp`).
  - Saves to `Client/uploads/<guid>.<ext>`.

### Avatars

Flow is similar, but with a dedicated endpoint:

- POST ` /api/users/avatar` (file in `IFormFile file`)
- Saves to `Client/uploads/avatars/<guid>.<ext>`
- Updates `User.AvatarUrl`
- Deletes the previous avatar file if it existed

Implementation:

- `Server/Controllers/UsersController.cs` (`UploadAvatar` action)

### Large Files (Chunked Upload)

For large files (> 5 MB) the client uses a **threeâ€‘step chunked upload**:

1. `POST /api/files/initiate`  
   - Body: `{ fileName, size, mimeType }`  
   - Response: `{ uploadId, chunkSize }`  
   - Server stores metadata + creates a temp `.bin` file.

2. `PUT /api/files/chunk/{uploadId}?offset=<n>`  
   - Body: raw bytes of each chunk.
   - Server appends each chunk to the `.bin` file.

3. `POST /api/files/complete/{uploadId}`  
   - Moves file from `uploads/temp` to:
     - `Client/uploads/files/<userId>/<yyyy>/<MM>/<dd>/...`
   - Returns `{ url, name, mime }`.

Implementation:

- `Server/Controllers/FilesController.cs`

The frontend wiring for this logic lives in `Client/app.js` around the chat form submit handler.

---

## ğŸ’¾ Database

### Storage Engine

- SQLite file at `parrotnest.db`, path resolved by `ServerHost.ResolveDbPath`:
  - Uses environment variables:
    - `PARROTNEST_DB_PATH` â€“ override location
    - `PARROTNEST_DB_PREFER_APPDATA` â€“ prefer `%LocalAppData%\ParrotnestServer\parrotnest.db`
  - Otherwise uses the database next to the running binary.

### Schema Highlights

Core tables (simplified):

- `Users` â€” accounts, avatars, preferences, admin flag
- `Friendships` â€” friend relationships with `Status` enum (`Pending`, `Accepted`, `Blocked`)
- `Groups` â€” chat groups with `OwnerId`
- `GroupMembers` â€” users in groups
- `Messages` â€” messages, references to sender/receiver/group, image URL, timestamp
- `AdminActionLogs` â€” admin audit log
- `GeneralChannelSettings` â€” settings for the global/general channel

Detailed SQL with indexes and views:

- `Server/database.sql`
- `Server/BAZA_DANYCH.md`

On startup the server:

- calls `Database.EnsureCreated()`,
- ensures foreign keys and basic indexes via `PRAGMA` commands and manual `CREATE INDEX` calls.

---

## ğŸ§ª Diagnostics & Tools

The project includes a diagnostic controller:

- `GET /api/diag/build`
  - assembly info, build timestamp, DB path & size
- `GET /api/diag/routes` (admin only)
  - list of all registered routes
- `GET /api/diag/dbstats` (admin only)
  - counts of records in key tables

These endpoints are especially useful to verify:

- that the correct server binary is running,
- that the database has the expected data,
- that routes are correctly registered.

See `Server/PRODUCTION_DEPLOY.md` for more details (in Polish).

---

## ğŸ“¦ Production Deployment (Quick Summary)

For full details, see `Server/PRODUCTION_DEPLOY.md`. In short:

1. Build release:
   ```bash
   dotnet build .\Server\ParrotnestServer.csproj -c Release
   ```
2. Copy:
   ```text
   Server\bin\Release\net10.0-windows\
   ```
   to the target machine.
3. Ensure the **Client** folder is present next to the binary.
4. Run:
   ```bash
   ParrotnestServer.exe --server
   ```
5. Expose or proxy `http://<host>:6069` as needed.

---

## ğŸ” Security Notes

- JWT signing key is configured under `Jwt:Key` in `Server/appsettings.json`.
- Always override the default key in production via environment variables or config:
  - e.g. `ASPNETCORE_ENVIRONMENT=Production` with a secure secret.
- The upload system:
  - restricts allowed file extensions for message images and avatars,
  - sanitizes filenames and strips relative paths for chunked uploads,
  - stores uploads under a dedicated `uploads` folder.

You should still:

- run behind a reverse proxy (e.g. nginx/IIS) with HTTPS,
- restrict who can access the admin account,
- secure the production host and file system.

---

## ğŸ™Œ Contributing & Customization

This repository is designed to be hackable and schoolâ€‘friendly:

- Customize the **PHP templates** in `Client/` to change branding and layout.
- Tweak **CSS** and themes (look for theme and textâ€‘size settings).
- Extend **C# controllers** to add new endpoints (e.g. extra admin tools).
- Add new **SignalR hub methods** for richer realâ€‘time interactions.

Ideas:

- ğŸ”” Add richer notification settings perâ€‘user
- ğŸ“ Add perâ€‘group file repositories
- ğŸ¨ Add more themes and perâ€‘group color schemes
- ğŸ“Š Add basic analytics for admins (message counts, active users, etc.)

---

## â¤ï¸ Credits

- Built with â¤ï¸ for classrooms and small communities.
- Uses openâ€‘source technologies from the .NET and web ecosystem.

If you find this project useful, feel free to star the repo, share it with your classmates, or fork it and build your own flavor of Parrotnest! ğŸ¦œâœ¨

## ğŸ‘‘ Creators
Adam ("Hnato")
Igor ("Flubi3604")
Jakub ("John0G1thub")

